!function(f){f.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);1===e.length&&"object"==typeof e[0]&&function(e){var a=this,i=f.extend(!0,{highlightWeekends:!0,highlightToday:!0,toggleableProjects:!0,cellWidth:20,slideWidth:400,kineticScroll:!0,startDate:!1,endDate:!1,startToday:!1,behavior:{clickable:!1,draggable:!0,resizable:!0}},e);i.data?t():i.dataUrl&&f.getJSON(i.dataUrl,function(e){i.data=e,t()});function t(){var e=Math.floor(i.slideWidth/i.cellWidth+5),t=w.getBoundaryDatesFromData(i.data,e);i.start=i.startDate?moment(i.startDate,"MM/DD/YYYY")._d:t[0],i.end=i.endDate?moment(i.endDate,"MM/DD/YYYY")._d:t[1],a.each(function(){var e=f(this),t=f("<div>",{class:"ganttview"});new n(t,i).render(),e.append(t);f("div.ganttview-vtheader",e).outerWidth(),f("div.ganttview-slide-container",e).outerWidth();new s(e,i).apply()})}}.call(this,e[0]),2===e.length&&"string"==typeof e[0]&&function(e,t){if("setSlideWidth"===e){var a=$("div.ganttview",this);a.each(function(){var e=$("div.ganttview-vtheader",a).outerWidth();$(a).width(e+t+1),$("div.ganttview-slide-container",this).width(t)})}}.call(this,e[0],e[1])};var n=function(a,i){function m(e,t,a){var i={parent:t.name};f.extend(i,a),e.data("block-data",i)}return{render:function(){!function(e,t){for(var a=f("<div>",{class:"ganttview-vtheader"}),i=0;i<t.length;i++){var n=f("<div>",{class:"ganttview-vtheader-group"});n.append(f("<div>",{class:"ganttview-vtheader-group-name",id:"groupId_"+i}).append(t[i].name).append("<span/>"));for(var s=f("<div>",{class:"ganttview-vtheader-series"}),d=0;d<t[i].series.length;d++){var r=f("<div>",{class:"ganttview-vtheader-series-row"});if(t[i].series[d].sub_series){var o=f("<div>",{class:"series-content"}),l=f("<div>",{class:"series-dates"}),c=f("<div>",{class:"series-users"});o.append('<div class="series-name">'+t[i].series[d].name+"</div>");for(var v=0;v<t[i].series[d].sub_series.length;v++){var g=0<v?'<span class="date-sep">|</span>':"",h=t[i].series[d].sub_series[v];if(h.user_avatar){var p=f("<div>",{class:"series-user"}),u=h.user_name,m=h.user_avatar;p.append('<span><img src="'+m+'" alt="'+u+'" title="'+u+'"/></span>'),c.append(p),r.append(c)}l.append(function(){return g+"<span data-event-id='"+t[i].series[d].sub_series[v].id+"'>"+moment(h.start,"MM/DD/YYYY").format("D MMM")+" - "+moment(h.end,"MM/DD/YYYY").format("D MMM")+"</span>"}),o.append(l),r.append(o)}}else r.append(function(){return(t[i].series[d].user_avatar?"<div class='series-user'><span><img src='"+t[i].series[d].user_avatar+"' alt='"+t[i].series[d].user_name+"' title='"+t[i].series[d].user_name+"'/></span></div>":"")+"<div class='series-content'><div class=\"series-name\">"+t[i].series[d].name+"</div><div class='series-dates'><span data-event-id='"+t[i].series[d].id+"'>"+moment(t[i].series[d].start,"MM/DD/YYYY").format("D MMM")+" - "+moment(t[i].series[d].end,"MM/DD/YYYY").format("D MMM")+"</span></div></div>"});s.append(r)}n.append(s),a.append(n)}e.append(a)}(a,i.data);var t=f("<div>",{class:"ganttview-slide-container"}),e=function(e,t){var a=[];a[e.getFullYear()]=[],a[e.getFullYear()][e.getMonth()]=[e];var i=e;for(;moment(t).isAfter(i);){var n=moment(i).add(1,"days")._d;a[n.getFullYear()]||(a[n.getFullYear()]=[]),a[n.getFullYear()][n.getMonth()]||(a[n.getFullYear()][n.getMonth()]=[]),a[n.getFullYear()][n.getMonth()].push(n),i=n}return a}(i.start,i.end);!function(e,t,a,i,n,s){var d=f("<div>",{class:"ganttview-hzheader"}),r=f("<div>",{class:"ganttview-hzheader-months"}),o=f("<div>",{class:"ganttview-hzheader-days"}),l=0;for(var c in t)for(var v in t[c]){var g=t[c][v].length*a;for(var h in l+=g,r.append(f("<div>",{class:"ganttview-hzheader-month",css:{width:g-1+"px"}}).append(moment(parseInt(v)+1,"M").format("MMMM")+" "+c)),t[c][v]){var p=f("<div>",{class:"ganttview-hzheader-day"});w.isWeekend(t[c][v][h])&&i&&p.addClass("ganttview-weekend"),moment(t[c][v][h]).isSame(Date.now(),"day")&&n&&p.addClass("ganttview-today"),moment(t[c][v][h]).isSame(Date.now(),"day")&&s&&p.addClass("ganttview-startToday"),o.append(p.append(t[c][v][h].getDate()))}}r.css("width",l+"px"),o.css("width",l+"px"),d.append(r).append(o),e.append(d)}(t,e,i.cellWidth,i.highlightWeekends,i.highlightToday,i.startToday),function(e,t,a,i,n,s){var d=f("<div>",{class:"ganttview-grid"}),r=f("<div>",{class:"ganttview-grid-row"});for(var o in a)for(var l in a[o])for(var c in a[o][l]){var v=f("<div>",{class:"ganttview-grid-row-cell"});w.isWeekend(a[o][l][c])&&n&&v.addClass("ganttview-weekend"),moment(a[o][l][c]).isSame(Date.now(),"day")&&s&&v.addClass("ganttview-today"),r.append(v)}var g=f("div.ganttview-grid-row-cell",r).length*i;r.css("width",g+"px"),d.css("width",g+"px");for(var h=0;h<t.length;h++){d.append(f("<div>",{class:"ganttview-grid-spacer","data-click-target":"groupId_"+h}));for(var p=0;p<t[h].series.length;p++)d.append(r.clone().addClass("groupId_"+h))}e.append(d)}(t,i.data,e,i.cellWidth,i.highlightWeekends,i.highlightToday),function(e,t){for(var a=f("<div>",{class:"ganttview-blocks"}),i=0;i<t.length;i++){a.append(f("<div>",{class:"ganttview-block-spacer"}));for(var n=0;n<t[i].series.length;n++)a.append(f("<div>",{class:"ganttview-block-container groupId_"+i}))}e.append(a)}(t,i.data),function(e,r,o,l){for(var c=f("div.ganttview-blocks div.ganttview-block-container",e),v=0,g=0;g<r.length;g++)for(var t=0;t<r[g].series.length;t++){if(r[g].series[t].sub_series){var h=r[g].series[t].sub_series,p=r[g].series[t].name.replace(/(<([^>]+)>)/gi," ");$.each(h,function(e,t){var a=w.daysBetween(t.start,t.end)+1,i=w.daysBetween(l,t.start),n=t.user_name?" ("+t.user_name+")":"",s=f("<div>",{class:"ganttview-block",title:p+n,"data-id":t.id,id:"ganttview-item-"+t.id,css:{width:a*o-7+"px",left:i*o+3+"px"}});m(s,r[g],h[e]),t.color&&s.css("background-color",t.color);var d=t.title?t.link?'<a href="'+t.link+'" title="'+t.link+'">'+t.title+"</a>":t.title:w.humanizeOutput(moment(t.start,"MM/DD/YYYY"),moment(t.end,"MM/DD/YYYY"));t.link?s.append(f("<div>",{class:"ganttview-block-text"}).html(d)):s.append(f("<div>",{class:"ganttview-block-text"}).text(d)),f(c[v]).append(s)})}else{var a=r[g].series[t],i=a.name.replace(/(<([^>]+)>)/gi," "),n=w.daysBetween(a.start,a.end)+1,s=w.daysBetween(l,a.start),d=f("<div>",{class:"ganttview-block",title:i,id:"ganttview-item-"+r[g].series[t].id,css:{width:n*o-7+"px",left:s*o+3+"px"}});m(d,r[g],a),r[g].series[t].color&&d.css("background-color",r[g].series[t].color);var u=a.title?a.link?'<a href="'+a.link+'" title="'+a.link+'">'+a.title+"</a>":a.title:w.humanizeOutput(moment(a.start,"MM/DD/YYYY"),moment(a.end,"MM/DD/YYYY"));a.link?d.append(f("<div>",{class:"ganttview-block-text"}).html(u)):d.append(f("<div>",{class:"ganttview-block-text"}).text(u)),f(c[v]).append(d)}v++}f(".ganttview-blocks").css({width:$(e).width()})}(t,i.data,i.cellWidth,i.start),a.append(t),f(a).find(".ganttview-blocks").width(t.find(".ganttview-grid").width()),function(e){f("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",e).addClass("last"),f("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",e).addClass("last"),f("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",e).addClass("last")}(a.parent()),i.toggleableProjects&&function(e){var t=[.55,0,.1,1];$("div.ganttview-vtheader-group-name",e).addClass("toggle_enabled").on("click",function(){var e=$(this).attr("id");$(this).hasClass("projectHidden")?($(this).removeClass("projectHidden").next("div").children().velocity("slideDown",{duration:180,easing:t}),$(".ganttview-block-container."+e).show(),$(".ganttview-grid-row."+e).velocity("slideDown",{duration:180,easing:t})):($(this).addClass("projectHidden").next("div").children().velocity("slideUp",{duration:180,easing:t}),$(".ganttview-block-container."+e).hide(),$(".ganttview-grid-row."+e).velocity("slideUp",{duration:180,easing:t}))}),$("div.ganttview-grid-spacer",e).on("click",function(){$("#"+$(this).attr("data-click-target")).click()})}(a),i.kineticScroll&&function(e){var t=f("div.ganttview-slide-container",e);$(t).kinetic({y:!1,filterTarget:function(e,t){return!($(e).closest(".ganttview-block").length||$(e).closest(".ganttview-grid-spacer").length)}})}(a),i.startToday&&setTimeout(function(){var e=w.daysBetween(i.start,moment()._d);t.scrollLeft(e*i.cellWidth)},100)}}},s=function(e,t){function d(e,t,a,i){var n=f("div.ganttview-slide-container",e),s=n.scrollLeft(),d=t.offset().left-n.offset().left-1+s,r=Math.round(d/a),o=moment(i).add(r,"days");t.data("block-data").start=o;var l=t.outerWidth(),c=Math.round(l/a)-1,v=moment(o).add(c,"days");t.data("block-data").end=v,t.data("block-data").title||f("div.ganttview-block-text",t).text(w.humanizeOutput(o,v))}return{apply:function(){t.behavior.clickable&&function(e,t){f("div.ganttview-block",e).on("click",function(){t&&t(f(this).data("block-data"))})}(e,t.behavior.onClick),t.behavior.resizable&&function(a,i,n,s){f("div.ganttview-block",a).resizable({grid:i,handles:"e,w",stop:function(){var e=f(this);d(a,e,i,n);var t=e.data("block-data");a.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),s&&s(e.data("block-data"))}})}(e,t.cellWidth,t.start,t.behavior.onResize),t.behavior.draggable&&function(a,i,n,s){f("div.ganttview-block",a).draggable({axis:"x",grid:[i,i],containment:"parent",stop:function(){var e=f(this);d(a,e,i,n);var t=e.data("block-data");a.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),s&&s(e.data("block-data"))}})}(e,t.cellWidth,t.start,t.behavior.onDrag)}}},w={daysBetween:function(e,t){return e&&t?(e=Date.parse(e),t=Date.parse(t),1901==moment(e)._d.getYear()||8099==moment(t)._d.getYear()?0:moment(t).diff(moment(e),"days")):0},isWeekend:function(e){return e.getDay()%6==0},getBoundaryDatesFromData:function(e,t){var n=new Date,s=new Date,a=[];return e.forEach(function(e){e.series.forEach(function(e){e.sub_series?e.sub_series.forEach(function(e){a.push(e)}):a.push(e)})}),a.forEach(function(e,t){var a=Date.parse(e.start),i=Date.parse(e.end);0===t&&(n=a,s=i),moment(n).isAfter(a)&&(n=a),moment(s).isBefore(i)&&(s=i)}),moment(s).diff(n,"days")<t&&(s=moment(n).add(t,"days")),[moment(n)._d,moment(s)._d]},humanizeOutput:function(e,t){var a=moment.duration(moment(t._d).diff(moment(e._d).subtract("1","day"))),i=a._locale._relativeTime.d,n=a._locale._relativeTime.dd,s=parseInt(a.asDays());return s=1<s?n.replace("%d",s):i}}}(jQuery);